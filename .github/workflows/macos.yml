name: MacOs SSH

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setting up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Installing Dependencies
        run: |
          brew install openssh
          pip install bs4 requests

      - name: Setup SSH Server
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          set -euo pipefail

          # Prepare environment
          sudo mkdir -p /opt/ssh
          cd /opt/ssh

          # Generate host keys
          sudo ssh-keygen -A

          SHORTNAME="runneradmin"
          REALNAME="SSH User"

          # Get next UID
          LAST_UID=$(dscl . -list /Users UniqueID 2>/dev/null | awk '{print $2}' | sort -n | tail -n1 || echo 501)
          NEXT_UID=$((LAST_UID + 1))
          if [ "$NEXT_UID" -le 501 ]; then
            NEXT_UID=502
          fi

          # Create user if not exists
          if ! dscl . -read /Users/"$SHORTNAME" >/dev/null 2>&1; then
            sudo dscl . -create /Users/"$SHORTNAME"
            sudo dscl . -create /Users/"$SHORTNAME" UserShell /bin/bash
            sudo dscl . -create /Users/"$SHORTNAME" RealName "$REALNAME"
            sudo dscl . -create /Users/"$SHORTNAME" UniqueID "$NEXT_UID"
            sudo dscl . -create /Users/"$SHORTNAME" PrimaryGroupID 20
            sudo dscl . -create /Users/"$SHORTNAME" NFSHomeDirectory /Users/"$SHORTNAME"
          fi

          # Ensure shell is valid
          if ! grep -q "/bin/bash" /etc/shells; then
            echo "/bin/bash" | sudo tee -a /etc/shells >/dev/null
          fi
          sudo chsh -s /bin/bash "$SHORTNAME"

          # Set password
          printf "%s\n" "$PASSWORD" | sudo dscl . -passwd /Users/"$SHORTNAME" "$PASSWORD" || true

          # Create home directory with correct permissions
          sudo mkdir -p /Users/"$SHORTNAME"
          sudo chown -R "$SHORTNAME":staff /Users/"$SHORTNAME"
          sudo chmod 755 /Users/"$SHORTNAME"

          # Build SSH config
          cat <<'SSHD' | sudo tee /opt/ssh/sshd_config >/dev/null
          Port 22
          ListenAddress 0.0.0.0
          PasswordAuthentication yes
          PermitRootLogin no
          PermitEmptyPasswords no
          ChallengeResponseAuthentication no
          UsePAM yes
          Subsystem sftp /usr/libexec/sftp-server
          GatewayPorts yes
          AllowTcpForwarding yes
          ClientAliveInterval 120
          SSHD

          sudo chmod 600 /opt/ssh/sshd_config

          # Start SSH service
          echo "Starting SSH server..."
          sudo /usr/sbin/sshd -f /opt/ssh/sshd_config -D &
          sleep 3

          echo "SSH ready on localhost:22 (user: $SHORTNAME)"

      - name: Run Python Script
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
          DB_ADMIN_URL: ${{ secrets.DB_ADMIN_URL }}
        run: |
          python main.py "macos-ssh-server:22" 22
