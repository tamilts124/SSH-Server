name: MacOS SSH Internal Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      # 3Ô∏è‚É£ Install dependencies
      - name: Install Dependencies
        run: |
          brew install openssh
          pip install bs4 requests

      # 4Ô∏è‚É£ Setup SSH Server (system default config)
      - name: Setup SSH Server
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          echo "üîß Creating SSH user..."
          sudo sysadminctl -addUser runneradmin -fullName "SSH User" -password "$PASSWORD" || true

          echo "üîß Enabling Remote Login..."
          sudo systemsetup -setremotelogin on || true

          echo "üîß Starting built-in SSH daemon..."
          sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist || true
          sudo launchctl start com.openssh.sshd || true

          echo "‚úÖ SSH service started using default macOS configuration"
          sudo launchctl list | grep ssh || true

      # 5Ô∏è‚É£ Run your Python script (unchanged)
      - name: Run Python Script
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
          DB_ADMIN_URL: ${{ secrets.DB_ADMIN_URL }}
        run: |
          python main.py "macos-ssh-server:22" 22
