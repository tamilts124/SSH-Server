name: MacOs SSH

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setting up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Installing Dependencies
        run: |
          brew install openssh
          pip install bs4 requests

      - name: Setup SSH Server
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          set -euo pipefail

          # prepare dir
          sudo mkdir -p /opt/ssh
          cd /opt/ssh

          # generate host keys (if missing)
          sudo ssh-keygen -A

          SHORTNAME="runneradmin"
          REALNAME="SSH User"

          # compute a free UniqueID (> 500)
          LAST_UID=$(dscl . -list /Users UniqueID 2>/dev/null | awk '{print $2}' | sort -n | tail -n1 || echo 501)
          NEXT_UID=$((LAST_UID + 1))
          if [ "$NEXT_UID" -le 501 ]; then
            NEXT_UID=502
          fi

          # create user with dscl (idempotent-ish)
          if ! dscl . -read /Users/"$SHORTNAME" >/dev/null 2>&1; then
            sudo dscl . -create /Users/"$SHORTNAME"
            sudo dscl . -create /Users/"$SHORTNAME" UserShell /bin/bash
            sudo dscl . -create /Users/"$SHORTNAME" RealName "$REALNAME"
            sudo dscl . -create /Users/"$SHORTNAME" UniqueID "$NEXT_UID"
            sudo dscl . -create /Users/"$SHORTNAME" PrimaryGroupID 20
            sudo dscl . -create /Users/"$SHORTNAME" NFSHomeDirectory /Users/"$SHORTNAME"
          fi

          # set password non-interactively
          printf "%s\n" "$PASSWORD" | sudo dscl . -passwd /Users/"$SHORTNAME" "$PASSWORD" >/dev/null 2>&1 || true

          # create home directory and set ownership (createhomedir is macOS helper)
          if [ ! -d /Users/"$SHORTNAME" ]; then
            sudo createhomedir -c -u "$SHORTNAME" >/dev/null 2>&1 || \
              ( sudo mkdir -p /Users/"$SHORTNAME" && sudo chown -R "$SHORTNAME":staff /Users/"$SHORTNAME" )
          else
            sudo chown -R "$SHORTNAME":staff /Users/"$SHORTNAME"
          fi

          # minimal sshd config (internal only)
          cat <<'SSHD' | sudo tee /opt/ssh/sshd_config >/dev/null
          Port 22
          ListenAddress 127.0.0.1
          HostKey /etc/ssh/ssh_host_rsa_key
          PasswordAuthentication yes
          PermitRootLogin no
          PermitEmptyPasswords no
          ChallengeResponseAuthentication no
          UsePAM yes
          Subsystem sftp /usr/libexec/sftp-server
          GatewayPorts no
          SSHD

          # ensure correct permissions for sshd files
          sudo chmod 600 /opt/ssh/sshd_config || true

          # start sshd (background)
          sudo /usr/sbin/sshd -f /opt/ssh/sshd_config -D &

          # small wait to ensure it's up
          sleep 2

      - name: Run Python Script
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
          DB_ADMIN_URL: ${{ secrets.DB_ADMIN_URL }}
        run: |
          python main.py "macos-ssh-server:22" 22
