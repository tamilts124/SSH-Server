name: MacOS Internal SSH Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install SSH Server
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          echo "ðŸ”§ Installing SSH server..."
          brew install openssh

          echo "ðŸ”§ Creating test user..."
          sudo sysadminctl -addUser runneradmin -fullName "SSH User" -password "$PASSWORD" || true

          echo "ðŸ”§ Enabling remote login..."
          sudo systemsetup -setremotelogin on || true

          echo "ðŸ”§ Starting SSH daemon..."
          sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist || true
          sudo launchctl start com.openssh.sshd || true

          echo "âœ… SSH daemon should now be active (default config)"
          sudo launchctl list | grep ssh || true
          echo "User created: runneradmin"
          echo "Password set from GitHub secret"

      - name: Run Python test (your internal SSH connection)
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
          DB_ADMIN_URL: ${{ secrets.DB_ADMIN_URL }}
        run: |
          python main.py "localhost:22" 22
